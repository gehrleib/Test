<xsl:stylesheet version="3.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:output method="xml" indent="yes" omit-xml-declaration="yes"/>
  <xsl:mode on-no-match="shallow-skip"/>

  <xsl:variable name="GUID_CONTROL_RESULT_ID" select="'ba027e6b-983b-4177-81bd-19dde7317753'"/>
  <xsl:variable name="GUID_PLAN_ID" select="'5fd374e6-81bc-47be-924a-b7c1f1892fed'"/>
  <xsl:variable name="GUID_STATUS" select="'b7ecb737-b318-46ff-9a57-a254b9d06095'"/>
  <xsl:variable name="GUID_EXPORTED" select="'0fd1978a-81e6-45cb-a8be-4b07d3cc463a'"/>

  <xsl:template match="/Records">
    <ArcherRecords>
      <xsl:for-each select="Record">
        <ArcherRecord>
          
          <Control_Result_ID>
            <xsl:value-of select="Field[@guid=$GUID_CONTROL_RESULT_ID]"/>
          </Control_Result_ID>

          <High_Level_Plans>
            <xsl:for-each select="Record">
              
              <xsl:variable name="isExported" select="Field[@guid=$GUID_EXPORTED]//ListValue = 'Yes'"/>
              <xsl:variable name="isApproved" select="Field[@guid=$GUID_STATUS]//ListValue = 'Complete'"/>

              <xsl:if test="$isExported and $isApproved">
                <Item>
                  <xsl:value-of select="Field[@guid=$GUID_PLAN_ID]"/>
                </Item>
              </xsl:if>
              
            </xsl:for-each>
          </High_Level_Plans>
          
        </ArcherRecord>
      </xsl:for-each>
    </ArcherRecords>
  </xsl:template>

</xsl:stylesheet>
